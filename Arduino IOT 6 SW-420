#define BLYNK_TEMPLATE_ID ""
#define BLYNK_TEMPLATE_NAME ""
#define BLYNK_AUTH_TOKEN ""

#include <WiFi.h>
#include <HTTPClient.h>
#include <BlynkSimpleEsp32.h>

// âš™ï¸ ConfiguraciÃ³n WiFi
char ssid[] = "";
char pass[] = "";

// âš™ï¸ Pines
#define SW420_PIN 33
#define LED_PIN 26
#define BUZZER_PIN 27

// âš™ï¸ Variables globales
bool alarmaActiva = true;
bool vibracionAnterior = false;
unsigned long lastDetectionTime = 0;
const unsigned long alarmaDuracion = 1000; // 1 segundo

// ğŸ”¢ Contador de vibraciones
unsigned int contadorVibraciones = 0;       // Total de vibraciones detectadas
const unsigned long intervaloRegistro = 30000; // 1 minuto (60000 ms)

// ğŸ§  Temporizador de Blynk
BlynkTimer timer;

// ğŸ§  Control desde la app (V1)
BLYNK_WRITE(V1) {
  alarmaActiva = param.asInt();
  Serial.print("ğŸ“± Alarma ");
  Serial.println(alarmaActiva ? "activada" : "desactivada");
}

// ğŸ§  ConexiÃ³n manual a WiFi
void conectarWiFi() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.print("ğŸŒ Conectando a WiFi: ");
    Serial.println(ssid);
    WiFi.begin(ssid, pass);
    unsigned long start = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - start < 10000) {
      Serial.print(".");
      delay(500);
    }
    if (WiFi.status() == WL_CONNECTED) {
      Serial.println("\nâœ… WiFi conectado correctamente!");
      Serial.print("ğŸ“¶ IP: ");
      Serial.println(WiFi.localIP());
    } else {
      Serial.println("\nâŒ No se pudo conectar al WiFi.");
    }
  }
}

// ğŸ§  Intento de conexiÃ³n a Blynk
void conectarBlynk() {
  if (!Blynk.connected()) {
    Serial.println("ğŸ”— Conectando a Blynk...");
    Blynk.connect(5000);
    if (Blynk.connected()) Serial.println("âœ… Conectado a Blynk!");
    else Serial.println("âŒ FallÃ³ la conexiÃ³n a Blynk.");
  }
}

// ğŸ§  ConfiguraciÃ³n inicial
void setup() {
  Serial.begin(115200);
  Serial.println("\n--- ğŸ’¥ Monitor de VibraciÃ³n Iniciado ---");

  pinMode(SW420_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);

  conectarWiFi();
  Blynk.config(BLYNK_AUTH_TOKEN);
  conectarBlynk();

  // ğŸ” Timers
  timer.setInterval(200L, leerVibracion);          // Leer sensor cada 200 ms
  timer.setInterval(10000L, conectarWiFi);         // Reintento WiFi cada 10 seg
  timer.setInterval(15000L, conectarBlynk);        // Reintento Blynk cada 15 seg
  timer.setInterval(intervaloRegistro, enviarConteo); // Enviar conteo cada minuto

  Serial.println("âœ… Setup completado. Sistema listo.");
}

// ğŸ§  Lectura del sensor SW-420
void leerVibracion() {
  bool vibracion = digitalRead(SW420_PIN);

  if (vibracion != vibracionAnterior) {
    vibracionAnterior = vibracion;

    if (vibracion) {
      contadorVibraciones++; // ğŸ”¢ Suma una vibraciÃ³n
      Serial.println("ğŸ’¥ VibraciÃ³n detectada!");
      Blynk.virtualWrite(V2, 1);

      if (alarmaActiva) {
        digitalWrite(LED_PIN, HIGH);
        digitalWrite(BUZZER_PIN, HIGH);

        // ğŸ”” NotificaciÃ³n push en Blynk
        Blynk.logEvent("vibracion_detectada", "Â¡VibraciÃ³n detectada!");

        lastDetectionTime = millis();
        enviarEvento("VibraciÃ³n detectada", "Alarma activa");
      } else {
        Serial.println("âš ï¸ VibraciÃ³n detectada, pero alarma desactivada.");
        enviarEvento("VibraciÃ³n detectada", "Alarma desactivada");
      }
    } else {
      Blynk.virtualWrite(V2, 0);
    }
  }

  // Apagar alarma tras 1 segundo
  if (digitalRead(BUZZER_PIN) == HIGH && millis() - lastDetectionTime > alarmaDuracion) {
    digitalWrite(LED_PIN, LOW);
    digitalWrite(BUZZER_PIN, LOW);
  }
}

// ğŸ”¢ Enviar conteo de vibraciones al Blynk y Google Sheets
void enviarConteo() {
  Serial.print("ğŸ“ˆ Vibraciones detectadas en el periodo: ");
  Serial.println(contadorVibraciones);

  // Mostrar en el widget V3
  Blynk.virtualWrite(V3, contadorVibraciones);

  // Enviar registro al Google Sheets
  enviarEvento("Conteo de vibraciones", String(contadorVibraciones));

  // Reiniciar contador
  contadorVibraciones = 0;
}

// ğŸ” Loop principal
void loop() {
  if (Blynk.connected()) Blynk.run();
  timer.run();
}

// ğŸ“¨ EnvÃ­o de evento a Google Sheets
void enviarEvento(String evento, String estado) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    String url = "";
    http.begin(url);
    http.addHeader("Content-Type", "application/json");
    String payload = "{\"evento\":\"" + evento + "\",\"estado\":\"" + estado + "\"}";
    int httpResponseCode = http.POST(payload);
    if (httpResponseCode > 0)
      Serial.println("ğŸ“¤ Evento enviado a Google Sheets: " + evento);
    else
      Serial.println("âš ï¸ Error enviando evento: " + String(httpResponseCode));
    http.end();
  } else {
    Serial.println("âŒ WiFi no conectado, no se pudo enviar a Sheets.");
  }
}
